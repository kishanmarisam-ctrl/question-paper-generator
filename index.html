<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="Generate exam questions from notes in any language.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Questo - Smart Question Paper Generator</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2995/2995101.png">

    <!-- Parsing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Google Fonts: Inter & Noto Sans (for broad language support) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Palette */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #8b5cf6;
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            
            --text-main: #1e293b;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            
            --border-light: #e2e8f0;
            --border-focus: #8b5cf6;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-pill: 9999px;

            --transition-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            /* Fallback to system fonts for proper rendering of Indic scripts */
            font-family: 'Inter', 'Noto Sans', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            min-height: 100vh;
            /* Padding bottom ensures content isn't hidden behind the floating button */
            padding-bottom: calc(90px + var(--safe-bottom)); 
        }

        /* --- Header --- */
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }
        
        .brand {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.1rem;
        }

        .logo-text {
            font-weight: 800;
            font-size: 1.35rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .tagline {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* --- Layout --- */
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* --- Animations --- */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .animate-enter {
            animation: fadeUp 0.6s var(--transition-smooth) forwards;
            opacity: 0;
        }

        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }

        /* --- Cards --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            box-shadow: var(--shadow-md);
            border: 1px solid white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-header {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            flex-shrink: 0;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
        }

        /* --- Forms --- */
        /* Default Mobile: 1 column */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        /* Tablet/Desktop: 2 columns */
        @media (min-width: 640px) {
            .form-grid { grid-template-columns: 1fr 1fr; gap: 1.25rem; }
            .span-full { grid-column: span 2; }
            .container { padding: 1.5rem; gap: 1.5rem; }
            .card { padding: 1.75rem; }
            .logo-text { font-size: 1.5rem; }
            .tagline { font-size: 0.875rem; }
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .input-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .input-field {
            background: var(--bg-input);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            font-size: 16px; /* Prevents iOS zoom */
            font-family: inherit;
            color: var(--text-main);
            transition: all 0.2s var(--transition-smooth);
            width: 100%;
            -webkit-appearance: none; /* Removes iOS internal shadows */
        }

        .input-field:focus {
            outline: none;
            background: white;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        /* --- Pills --- */
        .pills-container {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .pill-checkbox { display: none; }

        .pill-label {
            flex: 1; /* Equal width on mobile */
            text-align: center;
            justify-content: center;
            min-width: 100px;
            padding: 0.6rem 0.5rem;
            background: var(--bg-input);
            border-radius: var(--radius-pill);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s var(--transition-bounce);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .pill-checkbox:checked + .pill-label {
            background: white;
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.2);
            transform: translateY(-1px);
        }

        /* --- Upload Zone --- */
        .upload-zone {
            border: 2px dashed var(--border-light);
            border-radius: var(--radius-lg);
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: radial-gradient(circle at center, #f8fafc 0%, transparent 100%);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-zone:hover, .upload-zone.drag-active {
            border-color: var(--primary);
            background-color: rgba(99, 102, 241, 0.05);
        }

        .upload-zone.drag-active { transform: scale(0.98); }

        .cloud-icon {
            width: 40px;
            height: 40px;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            transition: color 0.3s;
        }

        .upload-zone:hover .cloud-icon {
            color: var(--primary);
            animation: pulse-ring 2s infinite;
        }

        .upload-text { font-weight: 600; color: var(--text-main); margin-bottom: 0.25rem; font-size: 0.95rem; }
        .upload-subtext { font-size: 0.75rem; color: var(--text-muted); }

        textarea.content-area {
            min-height: 150px;
            resize: vertical;
            line-height: 1.6;
            margin-top: 0.5rem;
        }

        /* --- History Section --- */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .history-item:hover {
            background: white;
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .history-info { display: flex; flex-direction: column; gap: 0.1rem; }
        .history-title { font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
        .history-meta { font-size: 0.75rem; color: var(--text-muted); }

        .history-actions { display: flex; gap: 0.5rem; }
        
        .btn-icon-small {
            background: none;
            border: none;
            padding: 0.25rem;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 4px;
        }
        .btn-icon-small:hover { color: var(--primary); background: #e0e7ff; }
        .btn-icon-small.delete:hover { color: #ef4444; background: #fee2e2; }

        /* --- Floating Action Bar (Mobile Sticky) --- */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1rem 1rem calc(1rem + var(--safe-bottom)) 1rem;
            background: linear-gradient(to top, white 80%, rgba(255,255,255,0));
            z-index: 90;
            display: flex;
            justify-content: center;
            pointer-events: none; /* Allow clicks through gradient area */
        }

        .btn-generate {
            width: 100%;
            max-width: 400px;
            padding: 1rem;
            border: none;
            border-radius: var(--radius-pill);
            background: var(--gradient);
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
            transition: transform 0.2s var(--transition-bounce), box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            pointer-events: auto; /* Re-enable clicks */
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4);
        }

        .btn-generate:active { transform: scale(0.98); }
        .btn-generate:disabled { background: var(--text-light); cursor: not-allowed; box-shadow: none; transform: none; }

        /* --- Output Section --- */
        .output-section { display: none; margin-bottom: 2rem; }
        .output-section.visible { display: block; animation: fadeUp 0.5s ease; }

        .tabs-header {
            display: flex;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 1.25rem;
            position: relative;
        }

        .tab-btn {
            flex: 1; /* Full width tabs on mobile */
            background: none;
            border: none;
            padding: 0.75rem 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
            text-align: center;
        }

        .tab-btn.active { color: var(--primary); }

        /* Animated underline */
        .tabs-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            height: 2px;
            width: 50%; /* 2 tabs = 50% width */
            background: var(--primary);
            transition: transform 0.3s var(--transition-smooth);
            transform: translateX(0); 
            border-radius: 2px;
        }

        /* Logic to move tab underline based on active tab */
        /* Note: JS handles exact position, but CSS default covers first tab */

        .paper-preview {
            background: white;
            min-height: 400px;
            font-family: 'Times New Roman', serif;
            color: black;
            /* Remove fixed padding to allow more space on mobile */
            padding: 0.5rem; 
        }

        .preview-header {
            text-align: center;
            border-bottom: 2px solid black;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        
        .preview-header h2 { text-transform: uppercase; margin-bottom: 0.25rem; font-size: 1.25rem; }
        .preview-meta { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem; margin-top: 0.5rem; }

        .question-block { margin-bottom: 1.5rem; }
        .q-text { font-size: 1.05rem; margin-bottom: 0.5rem; display: flex; gap: 0.25rem; align-items: baseline; }
        .q-text strong { flex-shrink: 0; } /* Prevents number from squishing */
        
        .q-opts { margin-left: 0.5rem; display: flex; flex-direction: column; gap: 0.4rem; }
        
        @media (min-width: 640px) {
            .paper-preview { padding: 0 1rem; }
            .preview-header h2 { font-size: 1.5rem; }
            .q-opts { margin-left: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        }

        /* --- Loader --- */
        .loader-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .loader-overlay.active { opacity: 1; pointer-events: auto; }
        
        .spinner {
            width: 48px; height: 48px;
            border: 4px solid var(--border-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Print --- */
        @media print {
            body { background: white; padding: 0; }
            header, .card:not(.output-card), .action-bar, .tabs-header { display: none !important; }
            .container { max-width: 100%; margin: 0; padding: 0; }
            .card.output-card { box-shadow: none; padding: 0; border: none; }
            .paper-preview { font-size: 12pt; padding: 0.5in; }
            .output-section { display: block !important; margin: 0; }
            .preview-header { margin-top: 0; }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <div class="logo-text">Questo ✨</div>
            <div class="tagline">Turn your notes into exam questions</div>
        </div>
    </header>

    <div class="container">
        
        <!-- Step 1: Config -->
        <div class="card animate-enter delay-1">
            <div class="card-header">
                <div class="card-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </div>
                <div class="card-title">Exam Details</div>
            </div>
            
            <div class="form-grid">
                <div class="input-group">
                    <label class="input-label">Subject</label>
                    <input type="text" class="input-field" id="subject" placeholder="e.g. History or विज्ञान">
                </div>
                <div class="input-group">
                    <label class="input-label">Topic / Chapter</label>
                    <input type="text" class="input-field" id="topic" placeholder="e.g. World War II or प्रकाश संस्लेशण">
                </div>
                <div class="input-group">
                    <label class="input-label">Total Marks</label>
                    <input type="number" class="input-field" id="marks" value="50">
                </div>
                <div class="input-group">
                    <label class="input-label">No. of Questions</label>
                    <input type="number" class="input-field" id="count" value="10" max="50">
                </div>
                
                <div class="input-group span-full">
                    <label class="input-label">Question Types</label>
                    <div class="pills-container">
                        <input type="checkbox" id="type-mcq" class="pill-checkbox" checked>
                        <label for="type-mcq" class="pill-label">MCQ</label>

                        <input type="checkbox" id="type-short" class="pill-checkbox" checked>
                        <label for="type-short" class="pill-label">Short</label>

                        <input type="checkbox" id="type-long" class="pill-checkbox">
                        <label for="type-long" class="pill-label">Long</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Upload / Content -->
        <div class="card animate-enter delay-2">
            <div class="card-header">
                <div class="card-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                </div>
                <div class="card-title">Source Material</div>
            </div>

            <div class="input-group">
                <div class="upload-zone" id="drop-zone">
                    <input type="file" id="file-input" hidden accept=".pdf,.doc,.docx,.ppt,.pptx,.txt">
                    <svg class="cloud-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2 15c.7 0 1.7-.6 1.7-1.4a3.5 3.5 0 0 0-3.4-3.4c-.4 0-.8.1-1.1.2A5.5 5.5 0 0 0 13 6c-2.7 0-4.9 1.9-5.4 4.5A3.5 3.5 0 0 0 3.5 14c0 1.9 1.6 3.5 3.5 3.5h.3"/></svg>
                    <div class="upload-text">Tap or drop file here</div>
                    <div class="upload-subtext">PDF, DOCX, PPTX supported</div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <label class="input-label">Content Preview (Editable)</label>
                    <textarea class="input-field content-area" id="content-text" placeholder="Paste notes in ANY language (Hindi, Telugu, English, etc.)"></textarea>
                </div>
            </div>
        </div>

        <!-- History Section (Initially Hidden) -->
        <div class="card animate-enter delay-3" id="history-card" style="display:none;">
            <div class="card-header">
                <div class="card-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
                </div>
                <div class="card-title">Recent Papers</div>
            </div>
            <div class="history-list" id="history-list">
                <!-- History Items Injected Here -->
            </div>
        </div>

        <!-- Step 3: Output -->
        <div class="card output-card output-section" id="output-card">
            <div class="tabs-header" id="tabs-header">
                <button class="tab-btn active" data-tab="paper">Question Paper</button>
                <button class="tab-btn" data-tab="key">Answer Key</button>
            </div>

            <div id="view-paper" class="paper-preview">
                <!-- Generated Paper Content -->
            </div>
            
            <div id="view-key" class="paper-preview" style="display: none;">
                <!-- Generated Key Content -->
            </div>
        </div>

    </div>

    <!-- Floating Action Bar -->
    <div class="action-bar animate-enter delay-3">
        <button class="btn-generate" id="btn-generate">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 15h18"/><path d="M21 8v13H3V8"/></svg>
            Generate Paper
        </button>
    </div>

    <!-- Loader -->
    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: 600; color: var(--primary);">Processing...</p>
    </div>

    <script>
        /* --- SERVICE WORKER REGISTRATION (PWA) --- */
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }

        /* --- UTILS --- */
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        /* --- STATE --- */
        const state = {
            content: '',
            paper: null,
            history: []
        };

        /* --- LOCALE DATA (Question Templates) --- */
        const LOCALE_TEMPLATES = {
            en: { mcq: "Complete the sentence:", short: "Briefly explain:", long: "Discuss in detail:" },
            es: { mcq: "Completa la frase:", short: "Explique brevemente:", long: "Discuta en detalle:" },
            fr: { mcq: "Complétez la phrase :", short: "Expliquez brièvement :", long: "Discutez en détail :" },
            de: { mcq: "Vervollständigen Sie den Satz:", short: "Erklären Sie kurz:", long: "Diskutieren Sie im Detail:" },
            it: { mcq: "Completa la frase:", short: "Spiega brevemente:", long: "Discuti in dettaglio:" },
            pt: { mcq: "Complete a frase:", short: "Explique brevemente:", long: "Discuta detalhadamente:" },
            zh: { mcq: "补充句子：", short: "简要解释：", long: "详细论述：" },
            ja: { mcq: "次の文を完成させてください：", short: "簡潔に説明してください：", long: "詳しく議論してください：" },
            ko: { mcq: "다음 문장을 완성하세요:", short: "간단히 설명하세요:", long: "상세히 논의하세요:" },
            ru: { mcq: "Дополните предложение:", short: "Кратко объясните:", long: "Обсудите подробно:" },
            hi: { mcq: "वाक्य पूरा करें:", short: "संक्षेप में समझाएं:", long: "विस्तार से चर्चा करें:" },
            te: { mcq: "వాక్యాన్ని పూర్తి చేయండి:", short: "క్లుప్తంగా వివరించండి:", long: "వివరంగా చర్చించండి:" },
            ar: { mcq: "أكمل الجملة:", short: "اشرح بإيجاز:", long: "ناقش بالتفصيل:" },
            default: { mcq: "Complete:", short: "Explain:", long: "Discuss:" }
        };

        /* --- ANIMATIONS & TABS --- */
        function initTabs() {
            const tabs = $$('.tab-btn');
            
            function updateUnderline(btn) {
                const index = Array.from(tabs).indexOf(btn);
                const style = document.createElement('style');
                style.innerHTML = `.tabs-header::after { transform: translateX(${index * 100}%); }`;
                const oldStyle = document.getElementById('tab-anim-style');
                if (oldStyle) oldStyle.remove();
                style.id = 'tab-anim-style';
                document.head.appendChild(style);
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    updateUnderline(tab);

                    const view = tab.dataset.tab;
                    if(view === 'paper') {
                        $('#view-paper').style.display = 'block';
                        $('#view-key').style.display = 'none';
                    } else {
                        $('#view-paper').style.display = 'none';
                        $('#view-key').style.display = 'block';
                    }
                });
            });
        }

        /* --- FILE HANDLING --- */
        const dropZone = $('#drop-zone');
        const fileInput = $('#file-input');
        const contentText = $('#content-text');

        function initFileUpload() {
            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-active');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-active');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-active');
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) handleFile(e.target.files[0]);
            });
        }

        async function handleFile(file) {
            showLoader(true);
            try {
                const text = await extractText(file);
                const current = contentText.value;
                contentText.value = current ? current + "\n\n" + text : text;
                contentText.focus();
                contentText.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (err) {
                alert("Error reading file: " + err.message);
            } finally {
                showLoader(false);
            }
        }

        async function extractText(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            const arrayBuffer = await file.arrayBuffer();

            if (ext === 'pdf') {
                if (!window.pdfjsLib) throw new Error("PDF Lib failed to load");
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + "\n";
                }
                return fullText;
            } else if (ext === 'docx') {
                if (!window.mammoth) throw new Error("Mammoth Lib failed to load");
                const result = await mammoth.extractRawText({ arrayBuffer });
                return result.value;
            } else if (ext === 'txt') {
                return new TextDecoder().decode(arrayBuffer);
            } else if (ext === 'pptx') {
                if (!window.JSZip) throw new Error("JSZip Lib failed to load");
                const zip = await JSZip.loadAsync(arrayBuffer);
                let text = "";
                const slideFiles = Object.keys(zip.files).filter(f => f.match(/ppt\/slides\/slide\d+\.xml/));
                for(const slide of slideFiles) {
                    const content = await zip.files[slide].async('string');
                    const div = document.createElement('div');
                    div.innerHTML = content.replace(/<[^>]+>/g, ' ');
                    text += div.textContent + "\n";
                }
                return text;
            } else {
                throw new Error("Unsupported format");
            }
        }

        /* --- GENERATION LOGIC WITH MULTI-LANGUAGE SUPPORT --- */
        
        // Simple language detector
        function detectLanguage(text) {
            const sample = text.substring(0, 1000);
            
            // Check Scripts
            if (/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff]/.test(sample)) {
                if (/[\u3040-\u30ff]/.test(sample)) return 'ja'; // Kana present -> Japanese
                return 'zh'; // Hanzi only -> Chinese
            }
            if (/[\uac00-\ud7af]/.test(sample)) return 'ko';
            if (/[\u0900-\u097f]/.test(sample)) return 'hi'; // Hindi (Devanagari)
            if (/[\u0c00-\u0c7f]/.test(sample)) return 'te'; // Telugu
            if (/[\u0600-\u06ff]/.test(sample)) return 'ar';
            if (/[\u0400-\u04ff]/.test(sample)) return 'ru';
            
            // Heuristics for Latin scripts (Stop words)
            const words = sample.toLowerCase().split(/\W+/);
            if (words.includes('le') || words.includes('la') || words.includes('et')) return 'fr';
            if (words.includes('el') || words.includes('la') || words.includes('y') || words.includes('en')) return 'es';
            if (words.includes('der') || words.includes('die') || words.includes('das') || words.includes('und')) return 'de';
            if (words.includes('il') || words.includes('la') || words.includes('di')) return 'it';
            if (words.includes('o') || words.includes('a') || words.includes('e') || words.includes('do')) return 'pt';

            return 'en'; // Default
        }

        function generateQuestions() {
            const subject = $('#subject').value;
            const topic = $('#topic').value;
            const marks = parseInt($('#marks').value) || 50;
            const count = parseInt($('#count').value) || 10;
            const text = contentText.value;
            
            if(!text.trim() || !subject || !topic) {
                alert("Please fill in Subject, Topic, and Content.");
                return;
            }

            const types = {
                mcq: $('#type-mcq').checked,
                short: $('#type-short').checked,
                long: $('#type-long').checked
            };

            if (!Object.values(types).some(Boolean)) {
                alert("Select at least one question type.");
                return;
            }

            showLoader(true);

            setTimeout(() => {
                try {
                    const lang = detectLanguage(text);
                    console.log("Detected Language:", lang);
                    
                    const questions = processTextToQuestions(text, count, types, lang);
                    
                    const paperData = {
                        id: Date.now(),
                        subject, topic, marks, questions, lang,
                        timestamp: new Date().toLocaleString()
                    };

                    saveHistory(paperData);
                    renderOutput(paperData);
                    
                    const output = $('#output-card');
                    output.classList.add('visible');
                    output.scrollIntoView({ behavior: 'smooth' });
                } catch(e) {
                    alert(e.message);
                    console.error(e);
                } finally {
                    showLoader(false);
                }
            }, 800);
        }

        function processTextToQuestions(text, count, types, lang) {
            // Clean text
            const cleanText = text.replace(/\s+/g, ' ').trim();
            
            // --- Advanced Sentence Splitting (Intl.Segmenter) ---
            let sentences = [];
            if (typeof Intl !== 'undefined' && Intl.Segmenter) {
                try {
                    const segmenter = new Intl.Segmenter(lang, { granularity: 'sentence' });
                    sentences = Array.from(segmenter.segment(cleanText)).map(x => x.segment.trim());
                } catch (e) {
                    // Fallback if lang not supported by Intl
                    sentences = cleanText.split(/[.!?|。！？]+/).map(s => s.trim());
                }
            } else {
                // Fallback for older browsers
                sentences = cleanText.match(/[^.!?|。！？]+[.!?|。！？]+/g) || [cleanText];
            }
            
            // Filter short segments
            const validSentences = sentences.filter(s => s.length > 15);
            if (validSentences.length < 2) throw new Error("Not enough content. Please provide at least 2-3 detailed sentences.");

            // --- Keyword Extraction (Intl.Segmenter) ---
            let keywords = [];
            if (typeof Intl !== 'undefined' && Intl.Segmenter) {
                try {
                    const wordSegmenter = new Intl.Segmenter(lang, { granularity: 'word' });
                    const segments = Array.from(wordSegmenter.segment(cleanText));
                    
                    // Filter "word-like" items that are long enough (avoids punctuation and common particles in CJK)
                    const minLen = ['zh','ja','te','hi'].includes(lang) ? 2 : 4;
                    keywords = segments
                        .filter(x => x.isWordLike && x.segment.length >= minLen)
                        .map(x => x.segment);
                } catch (e) {
                    keywords = cleanText.split(/\W+/).filter(w => w.length > 4);
                }
            } else {
                // Fallback splitting
                keywords = cleanText.split(/\W+/).filter(w => w.length > 4);
            }
            
            // Unique keywords
            keywords = [...new Set(keywords)];

            const questions = [];
            const activeTypes = [];
            if(types.mcq) activeTypes.push('MCQ');
            if(types.short) activeTypes.push('SHORT');
            if(types.long) activeTypes.push('LONG');
            
            const templates = LOCALE_TEMPLATES[lang] || LOCALE_TEMPLATES.default;

            for(let i=0; i<count; i++) {
                const type = activeTypes[i % activeTypes.length];
                const sentence = validSentences[i % validSentences.length];
                const q = createQuestion(i+1, type, sentence, keywords, templates, lang);
                questions.push(q);
            }
            return questions;
        }

        function createQuestion(id, type, sentence, keywords, templates, lang) {
            let target = "";
            
            // Extract a target word from the sentence itself
            if (typeof Intl !== 'undefined' && Intl.Segmenter) {
                 try {
                     const wordSegmenter = new Intl.Segmenter(lang, { granularity: 'word' });
                     const words = Array.from(wordSegmenter.segment(sentence)).filter(x => x.isWordLike && x.segment.length >= 2);
                     target = words.length ? words[Math.floor(Math.random() * words.length)].segment : "it";
                 } catch (e) {
                    const words = sentence.split(/\s+/);
                    target = words.find(w => w.length > 4) || words[0];
                 }
            } else {
                 const words = sentence.split(/\W+/);
                 target = words.find(w => w.length > 5) || words[words.length-1];
            }
            
            const q = { id, type, answer: target };

            if (type === 'MCQ') {
                // Replace target with underline
                q.text = `${templates.mcq} "${sentence.replace(target, '__________')}"`;
                q.marks = 1;
                const opts = new Set([target]);
                let safety = 0;
                while(opts.size < 4 && safety < 50) {
                    const rnd = keywords[Math.floor(Math.random() * keywords.length)];
                    if(rnd && rnd !== target) opts.add(rnd);
                    safety++;
                }
                q.options = Array.from(opts).sort(() => Math.random() - 0.5);
                q.answer = target;
            } else if (type === 'SHORT') {
                q.text = `${templates.short} "${target}" (${sentence.substring(0, 40)}...)`;
                q.marks = 3;
                q.answer = sentence;
            } else {
                q.text = `${templates.long} "${sentence.substring(0, 80)}..."`;
                q.marks = 5;
                q.answer = sentence;
            }
            return q;
        }

        function renderOutput(data) {
            const { subject, topic, marks, questions } = data;
            const paperView = $('#view-paper');
            const keyView = $('#view-key');
            
            let html = `
                <div class="preview-header">
                    <h2>${subject}</h2>
                    <p>${topic}</p>
                    <div class="preview-meta">
                        <span>Time: 1 hr</span>
                        <span>Max Marks: ${marks}</span>
                    </div>
                </div>
            `;

            questions.forEach(q => {
                html += `
                    <div class="question-block">
                        <div class="q-text">
                            <strong>${q.id}.</strong> 
                            <span>${q.text}</span>
                            <span style="margin-left:auto; font-size:0.9em; font-weight:bold;">[${q.marks}]</span>
                        </div>
                `;
                if(q.type === 'MCQ') {
                    html += `<div class="q-opts">`;
                    q.options.forEach((opt, idx) => {
                        html += `<div>${String.fromCharCode(97+idx)}) ${opt}</div>`;
                    });
                    html += `</div>`;
                }
                html += `</div>`;
            });
            paperView.innerHTML = html;

            let keyHtml = `
                <div class="preview-header">
                    <h2>Answer Key</h2>
                    <p>${subject} - ${topic}</p>
                </div>
            `;
            questions.forEach(q => {
                keyHtml += `
                    <div style="margin-bottom:1rem; border-bottom:1px dashed #ccc; padding-bottom:0.5rem;">
                        <div><strong>Q${q.id}</strong>: ${q.answer}</div>
                    </div>
                `;
            });
            keyView.innerHTML = keyHtml;
        }

        /* --- HISTORY LOGIC --- */
        function saveHistory(data) {
            state.history.unshift(data);
            if (state.history.length > 10) state.history.pop();
            localStorage.setItem('smart_paper_history', JSON.stringify(state.history));
            renderHistoryList();
        }

        function loadHistory() {
            try {
                const stored = localStorage.getItem('smart_paper_history');
                if (stored) {
                    state.history = JSON.parse(stored);
                    renderHistoryList();
                }
            } catch(e) { console.error("History load error", e); }
        }

        function renderHistoryList() {
            const historyCard = $('#history-card');
            const listContainer = $('#history-list');
            
            if (state.history.length === 0) {
                historyCard.style.display = 'none';
                return;
            }
            
            historyCard.style.display = 'block';
            listContainer.innerHTML = '';

            state.history.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'history-item';
                el.innerHTML = `
                    <div class="history-info" onclick="restorePaper(${index})">
                        <div class="history-title">${item.subject}</div>
                        <div class="history-meta">${item.topic} • ${item.questions.length} Qs • ${item.lang.toUpperCase()}</div>
                    </div>
                    <div class="history-actions">
                        <button class="btn-icon-small delete" onclick="deletePaper(${index})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
                listContainer.appendChild(el);
            });
        }

        window.restorePaper = (index) => {
            const paper = state.history[index];
            renderOutput(paper);
            $('#output-card').classList.add('visible');
            $('#output-card').scrollIntoView({ behavior: 'smooth' });
        };

        window.deletePaper = (index) => {
            if(confirm('Remove this paper from history?')) {
                state.history.splice(index, 1);
                localStorage.setItem('smart_paper_history', JSON.stringify(state.history));
                renderHistoryList();
            }
        };

        function showLoader(show) {
            const loader = $('#loader');
            if(show) loader.classList.add('active');
            else loader.classList.remove('active');
        }

        /* --- INIT --- */
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            initFileUpload();
            loadHistory();
            $('#btn-generate').addEventListener('click', generateQuestions);
            
            // Auto-focus first input
            setTimeout(() => $('#subject').focus(), 500);
        });

    </script>
</body>
</html>